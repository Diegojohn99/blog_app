<%= form_with(model: article) do |form| %>
  <% if article.errors.any? %>
    <div style="color: red">
      <h2><%= pluralize(article.errors.count, "error") %> prohibieron guardar este art√≠culo:</h2>
      <ul>
        <% article.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div>
    <%= form.label :title, "T√≠tulo", style: "display: block" %>
    <%= form.text_field :title, style: "width: 100%; padding: 0.5rem;" %>
  </div>

  <div>
    <%= form.label :content, "Contenido", style: "display: block" %>
    <%= form.text_area :content, rows: 10, style: "width: 100%; padding: 0.5rem;" %>
  </div>

  <div>
    <%= form.label :image, "Imagen de Portada", style: "display: block" %>
    
    <!-- Tabs for Image Upload or URL -->
    <div style="margin-bottom: 10px;">
      <button type="button" onclick="showImageTab('upload')" id="tab-upload" style="padding: 8px 16px; background: var(--yahoo-purple); color: white; border: none; border-radius: 4px 0 0 4px; cursor: pointer;">
        Subir Archivo
      </button>
      <button type="button" onclick="showImageTab('url')" id="tab-url" style="padding: 8px 16px; background: #e0e4e9; color: #333; border: none; border-radius: 0 4px 4px 0; cursor: pointer;">
        URL de Imagen
      </button>
    </div>

    <!-- Upload Tab -->
    <div id="image-upload-tab">
      <%= form.file_field :image, accept: "image/*", onchange: "previewImage(event)", style: "width: 100%; padding: 0.5rem; margin-bottom: 10px;" %>
    </div>

    <!-- URL Tab -->
    <div id="image-url-tab" style="display: none;">
      <%= form.text_field :image_url, id: "image-url-input", placeholder: "https://ejemplo.com/imagen.jpg", style: "width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 10px;" %>
      <button type="button" onclick="loadImageFromUrl()" style="padding: 8px 16px; background: var(--yahoo-purple); color: white; border: none; border-radius: 4px; cursor: pointer;">
        Cargar Imagen
      </button>
    </div>

    <!-- Image Cropper -->
    <div id="image-cropper-container" style="display: none; margin-top: 20px; border: 2px solid #6001d2; border-radius: 8px; padding: 20px; background: #f8f9fa;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h4 style="margin: 0;">Recortar Imagen</h4>
        <button type="button" onclick="closeCropper()" style="background: #dc2626; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">
          Cancelar
        </button>
      </div>
      
      <div style="max-width: 100%; max-height: 500px; overflow: hidden; background: #000; border-radius: 4px;">
        <img id="crop-image" src="" style="max-width: 100%; display: block;">
      </div>
      
      <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
        <button type="button" onclick="cropImage()" style="background: var(--yahoo-purple); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: 600;">
          ‚úì Aplicar Recorte
        </button>
        <button type="button" onclick="cropper.rotate(-90)" style="background: #4b5563; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
          ‚Ü∂ Rotar Izq
        </button>
        <button type="button" onclick="cropper.rotate(90)" style="background: #4b5563; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
          ‚Ü∑ Rotar Der
        </button>
        <button type="button" onclick="cropper.scaleX(-cropper.getData().scaleX || -1)" style="background: #4b5563; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
          ‚Üî Voltear H
        </button>
        <button type="button" onclick="cropper.scaleY(-cropper.getData().scaleY || -1)" style="background: #4b5563; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
          ‚Üï Voltear V
        </button>
        <button type="button" onclick="cropper.reset()" style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
          ‚ü≤ Resetear
        </button>
      </div>
      
      <div style="margin-top: 15px; padding: 12px; background: #e0e7ff; border-radius: 4px; font-size: 0.9rem;">
        <strong>üí° Instrucciones:</strong>
        <ul style="margin: 8px 0 0 0; padding-left: 20px;">
          <li>Arrastra las esquinas para ajustar el √°rea de recorte</li>
          <li>Mueve el √°rea de recorte arrastr√°ndola</li>
          <li>Usa la rueda del mouse para hacer zoom</li>
          <li>Haz clic en "Aplicar Recorte" cuando est√©s satisfecho</li>
        </ul>
      </div>
    </div>

    <!-- Initial Preview (shown first) -->
    <div id="initial-preview-container" style="display: none; margin-top: 15px; border: 2px dashed #6001d2; border-radius: 8px; padding: 20px; background: #f8f9fa;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h4 style="margin: 0;">Vista Previa</h4>
        <button type="button" onclick="removeImage()" style="background: #dc2626; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
          ‚úï Quitar
        </button>
      </div>
      
      <div style="position: relative; width: 100%; max-height: 400px; background: #e9ecef; border-radius: 4px; overflow: hidden; display: flex; align-items: center; justify-content: center;">
        <img id="initial-preview" src="" alt="Preview" style="max-width: 100%; max-height: 400px; object-fit: contain;">
      </div>
      
      <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
        <button type="button" onclick="startCropping()" style="background: var(--yahoo-purple); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: 600;">
          ‚úÇÔ∏è Recortar Imagen
        </button>
        <button type="button" onclick="useImageAsIs()" style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: 600;">
          ‚úì Usar Imagen Completa
        </button>
      </div>
      
      <p style="margin-top: 10px; font-size: 0.9rem; color: #6b7280;">
        Puedes usar la imagen tal como est√° o recortarla a tu gusto.
      </p>
    </div>

    <!-- Final Preview -->    <div id="final-preview-container" style="display: none; margin-top: 15px; border: 2px dashed #ccc; border-radius: 8px; padding: 20px; background: #f8f9fa;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h4 style="margin: 0;">Vista Final</h4>
        <button type="button" onclick="editCrop()" style="background: var(--yahoo-purple); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
          ‚úèÔ∏è Editar Recorte
        </button>
      </div>
      
      <%= form.label :image_style, "Estilo de Visualizaci√≥n", style: "display: block; font-size: 0.9rem; margin-bottom: 8px;" %>
      <%= form.select :image_style, 
          [["Recortar (Rellenar espacio)", "cover"], ["Completa (Ver toda la imagen)", "contain"]], 
          {}, 
          { 
            id: "image-style-select",
            onchange: "updateFinalPreviewStyle()",
            style: "width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc; margin-bottom: 15px;" 
          } %>
      
      <div style="position: relative; width: 100%; height: 200px; background: #e9ecef; border-radius: 4px; overflow: hidden; display: flex; align-items: center; justify-content: center;">
        <img id="final-preview" src="" alt="Preview" style="max-width: 100%; max-height: 100%; object-fit: cover;">
      </div>
      
      <input type="hidden" id="cropped-image-data" name="article[cropped_image]">
    </div>
  </div>

  <div>
    <%= form.submit "Guardar Art√≠culo", style: "margin-top: 1rem; padding: 0.5rem 1rem; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;" %>
  </div>
<% end %>

<script>
  // Handle form submission to prevent sending both file and cropped data
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    if (form) {
      form.addEventListener('submit', function(e) {
        const croppedImageData = document.getElementById('cropped-image-data');
        const fileInput = document.querySelector('input[type="file"]');
        
        // If we have cropped image data, clear the file input to avoid conflicts
        if (croppedImageData && croppedImageData.value) {
          if (fileInput) {
            fileInput.value = '';
          }
        }
      });
    }
  });
</script>

<!-- Cropper.js CDN -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

<script>
let cropper = null;
let originalImageSrc = null;

function showImageTab(tab) {
  const uploadTab = document.getElementById('image-upload-tab');
  const urlTab = document.getElementById('image-url-tab');
  const uploadBtn = document.getElementById('tab-upload');
  const urlBtn = document.getElementById('tab-url');
  
  if (tab === 'upload') {
    uploadTab.style.display = 'block';
    urlTab.style.display = 'none';
    uploadBtn.style.background = 'var(--yahoo-purple)';
    uploadBtn.style.color = 'white';
    urlBtn.style.background = '#e0e4e9';
    urlBtn.style.color = '#333';
  } else {
    uploadTab.style.display = 'none';
    urlTab.style.display = 'block';
    uploadBtn.style.background = '#e0e4e9';
    uploadBtn.style.color = '#333';
    urlBtn.style.background = 'var(--yahoo-purple)';
    urlBtn.style.color = 'white';
  }
}

function previewImage(event) {
  const file = event.target.files[0];
  if (file) {
    // Validate file type
    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
    if (!validTypes.includes(file.type)) {
      alert('‚ùå Formato de archivo no v√°lido. Por favor, selecciona una imagen (JPG, PNG, GIF o WebP).');
      event.target.value = ''; // Clear the input
      return;
    }
    
    // Validate file size (10MB max)
    const maxSize = 10 * 1024 * 1024; // 10MB in bytes
    if (file.size > maxSize) {
      alert('‚ùå La imagen es demasiado grande. Por favor, selecciona una imagen menor a 10MB.');
      event.target.value = ''; // Clear the input
      return;
    }
    
    // Clear any previous data
    document.getElementById('cropped-image-data').value = '';
    document.getElementById('final-preview-container').style.display = 'none';
    document.getElementById('image-cropper-container').style.display = 'none';
    
    const reader = new FileReader();
    reader.onload = function(e) {
      originalImageSrc = e.target.result;
      showInitialPreview(e.target.result);
    };
    reader.onerror = function() {
      alert('‚ùå Error al leer el archivo. Por favor, intenta con otra imagen.');
      event.target.value = '';
    };
    reader.readAsDataURL(file);
  }
}

function loadImageFromUrl() {
  const url = document.getElementById('image-url-input').value.trim();
  
  if (!url) {
    alert('‚ö†Ô∏è Por favor, ingresa una URL de imagen.');
    return;
  }
  
  // Basic URL validation
  try {
    const urlObj = new URL(url);
    if (!urlObj.protocol.startsWith('http')) {
      alert('‚ùå URL inv√°lida. Por favor, usa una URL que comience con http:// o https://');
      return;
    }
  } catch (e) {
    alert('‚ùå URL inv√°lida. Por favor, verifica la URL e intenta nuevamente.');
    return;
  }
  
  // Show loading indicator
  const loadBtn = event.target;
  const originalText = loadBtn.textContent;
  loadBtn.textContent = 'Cargando...';
  loadBtn.disabled = true;
  
  // Clear any previous data
  document.getElementById('cropped-image-data').value = '';
  document.getElementById('final-preview-container').style.display = 'none';
  document.getElementById('image-cropper-container').style.display = 'none';
  
  // Try to load the image
  const img = new Image();
  img.crossOrigin = 'anonymous';
  
  img.onload = function() {
    originalImageSrc = url;
    showInitialPreview(url);
    loadBtn.textContent = originalText;
    loadBtn.disabled = false;
  };
  
  img.onerror = function() {
    alert('‚ùå No se pudo cargar la imagen desde la URL. Verifica que:\n\n' +
          '‚Ä¢ La URL sea correcta y accesible\n' +
          '‚Ä¢ La imagen exista en esa ubicaci√≥n\n' +
          '‚Ä¢ No haya restricciones de CORS\n\n' +
          'Intenta con otra URL o sube la imagen desde tu dispositivo.');
    loadBtn.textContent = originalText;
    loadBtn.disabled = false;
  };
  
  img.src = url;
}

function showInitialPreview(src) {
  // Hide other containers
  document.getElementById('image-cropper-container').style.display = 'none';
  document.getElementById('final-preview-container').style.display = 'none';
  
  // Show initial preview
  const container = document.getElementById('initial-preview-container');
  const previewImg = document.getElementById('initial-preview');
  
  previewImg.src = src;
  container.style.display = 'block';
}

function startCropping() {
  if (!originalImageSrc) return;
  
  // Hide initial preview
  document.getElementById('initial-preview-container').style.display = 'none';
  
  showCropper(originalImageSrc);
}

function useImageAsIs() {
  if (!originalImageSrc) return;
  
  // Hide initial preview
  document.getElementById('initial-preview-container').style.display = 'none';
  
  // Show final preview with the original image
  document.getElementById('final-preview').src = originalImageSrc;
  document.getElementById('cropped-image-data').value = originalImageSrc;
  document.getElementById('final-preview-container').style.display = 'block';
  
  updateFinalPreviewStyle();
}

function removeImage() {
  // Clear everything
  document.getElementById('initial-preview-container').style.display = 'none';
  document.getElementById('image-cropper-container').style.display = 'none';
  document.getElementById('final-preview-container').style.display = 'none';
  
  // Clear inputs
  const fileInput = document.querySelector('input[type="file"]');
  if (fileInput) fileInput.value = '';
  
  const urlInput = document.getElementById('image-url-input');
  if (urlInput) urlInput.value = '';
  
  // Clear data
  document.getElementById('cropped-image-data').value = '';
  
  if (cropper) {
    cropper.destroy();
    cropper = null;
  }
  
  originalImageSrc = null;
}

function showCropper(src) {
  const container = document.getElementById('image-cropper-container');
  const cropImage = document.getElementById('crop-image');
  
  // Show cropper
  container.style.display = 'block';
  cropImage.src = src;
  
  // Destroy previous cropper if exists
  if (cropper) {
    cropper.destroy();
  }
  
  // Initialize new cropper
  cropper = new Cropper(cropImage, {
    aspectRatio: NaN, // Free aspect ratio
    viewMode: 1,
    dragMode: 'move',
    autoCropArea: 0.8,
    restore: false,
    guides: true,
    center: true,
    highlight: true,
    cropBoxMovable: true,
    cropBoxResizable: true,
    toggleDragModeOnDblclick: false,
  });
}

function cropImage() {
  if (!cropper) {
    alert('‚ö†Ô∏è No hay imagen para recortar.');
    return;
  }
  
  try {
    const canvas = cropper.getCroppedCanvas({
      maxWidth: 1920,
      maxHeight: 1920,
      fillColor: '#fff',
      imageSmoothingEnabled: true,
      imageSmoothingQuality: 'high',
    });
    
    if (!canvas) {
      alert('‚ùå Error al recortar la imagen. Por favor, intenta nuevamente.');
      return;
    }
    
    const croppedImageData = canvas.toDataURL('image/jpeg', 0.9);
    
    // Show final preview
    document.getElementById('final-preview').src = croppedImageData;
    document.getElementById('cropped-image-data').value = croppedImageData;
    document.getElementById('final-preview-container').style.display = 'block';
    
    // Hide cropper
    document.getElementById('image-cropper-container').style.display = 'none';
    
    updateFinalPreviewStyle();
  } catch (e) {
    console.error('Error cropping image:', e);
    alert('‚ùå Error al procesar el recorte. Por favor, intenta nuevamente.');
  }
}

function editCrop() {
  if (originalImageSrc) {
    showCropper(originalImageSrc);
  }
}

function closeCropper() {
  document.getElementById('image-cropper-container').style.display = 'none';
  
  // Show initial preview again if we have an image
  if (originalImageSrc) {
    showInitialPreview(originalImageSrc);
  } else {
    document.getElementById('initial-preview-container').style.display = 'none';
    document.getElementById('final-preview-container').style.display = 'none';
    
    // Clear inputs
    const fileInput = document.querySelector('input[type="file"]');
    if (fileInput) fileInput.value = '';
    
    const urlInput = document.getElementById('image-url-input');
    if (urlInput) urlInput.value = '';
    
    // Clear data
    document.getElementById('cropped-image-data').value = '';
  }
  
  if (cropper) {
    cropper.destroy();
    cropper = null;
  }
}

function updateFinalPreviewStyle() {
  const preview = document.getElementById('final-preview');
  const style = document.getElementById('image-style-select').value;
  preview.style.objectFit = style;
}
</script>

<style>
  /* Responsive styles for the form */
  @media (max-width: 768px) {
    #image-cropper-container {
      padding: 15px;
    }

    #image-cropper-container > div:first-child {
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
    }

    #image-cropper-container > div:nth-child(3) {
      flex-direction: column;
      gap: 8px;
    }

    #image-cropper-container button,
    #final-preview-container button {
      width: 100%;
      padding: 12px 16px !important;
    }

    #final-preview-container {
      padding: 15px;
    }

    input[type="text"],
    input[type="file"],
    textarea,
    select {
      font-size: 16px !important; /* Prevents zoom on iOS */
    }

    /* Tab buttons */
    #tab-upload,
    #tab-url {
      flex: 1;
      padding: 10px 12px !important;
      font-size: 0.9rem;
    }
  }

  @media (max-width: 480px) {
    #image-cropper-container h4,
    #final-preview-container h4 {
      font-size: 1rem;
    }

    #image-cropper-container ul li {
      font-size: 0.85rem;
    }
  }
</style>
